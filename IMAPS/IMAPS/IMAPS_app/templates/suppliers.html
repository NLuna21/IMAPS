<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Suppliers Inventory</title>
  <link rel="stylesheet" href="{% static 'IMAPS_app/css/styles.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<style>
  /* Form styling */
  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
  }

  .form-group input[type="text"],
  .form-group input[type="email"],
  .form-group input[type="tel"],
  .form-group input[type="password"],


  /* Radio button styling */
  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-top: 5px;
  }

  .radio-option {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }

  .radio-option input[type="radio"] {
    width: 16px;
    height: 16px;
    margin: 0;
    cursor: pointer;
  }

  .radio-option label {
    cursor: pointer;
    padding-left: 6px;
    font-size: 14px;
    margin-bottom: 0;
    font-weight: normal;
  }

  /* Required field asterisk */
  .required-asterisk {
    color: red;
    margin-left: 2px;
  }

  /* Form group with radio buttons */
  .form-group:has(.radio-group) {
    margin-bottom: 10px;
  }

  /* Alert messages */
  .alert {
    background-color: #f8d7da;
    color: #721c24;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
  }
</style>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="logo">
      <img src="{% static 'IMAPS_app/images/logo.png' %}" alt="Glow Glass Logo">
    </div>
    <ul class="nav-menu">
      <li class="nav-item">
        <a href="{% url 'packaging_list' %}">
          <span class="icon">üì¶</span>
          <span class="text">Packaging Materials</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'ingredients_list' %}">
          <span class="icon">üåø</span>
          <span class="text">Ingredients</span>
        </a>
      </li>
      <li class="nav-item active">
        <a href="{% url 'suppliers_list' %}">
          <span class="icon">üè≠</span>
          <span class="text">Suppliers</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'report_summary' %}">
          <span class="icon">üìä</span>
          <span class="text">Generate Report</span>
        </a>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <h1>Suppliers Inventory</h1>
    <div class="button-container">
      <button class="button-outline" onclick="openModal('addSupplierModal')">+ Add Supplier</button>
      <button class="import-button">Import Data</button>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <!-- Pagination on the left -->
            <th class="pagination" colspan="4" style="text-align: left;">
              Page <span id="supCurrentPage">1</span>/<span id="supTotalPages">1</span>
              <button class="pageButton" onclick="changeSupplierPage(-1)" id="supPrev">&lt;</button>
              <button class="pageButton" onclick="changeSupplierPage(1)" id="supNext">&gt;</button>
            </th>
          
            <!-- Search bar on the right -->
            <th class="search-bar-container" colspan="5" style="text-align: right;">
              <div class="search-bar" style="display: inline-flex; align-items: center;">
                <!-- Search icon (acts as submit) -->
                <i class="fa-solid fa-magnifying-glass search-icon"
                   id="supplierSearchIcon"
                   style="cursor: pointer; margin-right: 6px;"></i>
          
                <!-- Search input -->
                <input type="text"
                       id="supplierSearchInput"
                       class="search-input"
                       placeholder="Search Suppliers..."
                       style="padding: 4px 8px; font-size: 14px;">
          
                <!-- Hamburger menu for future filters -->
                <button class="menu-button"
                        id="supplierFilterMenu"
                        style="background: none; border: none; margin-left: 8px; cursor: pointer;">
                  <svg viewBox="0 0 24 24" width="20" height="20">
                    <path d="M3 12h18M3 6h18M3 18h18"
                          stroke="#555"
                          stroke-width="2"
                          stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </th>
          </tr>
          <tr>
            <th>Supplier Code</th>
            <th>Supplier Name</th>
            <th>Category</th>
            <th>Status</th>
            <th>Point Person</th>
            <th>Contact Number</th>
            <th>Email Address</th>
            <th>Social Media</th>
            <th>Options</th>
          </tr>
        </thead>
        <tbody id="supplierTableBody">
          {% for sup in suppliers %}
          <tr>
            <td>{{ sup.SupplierCode }}</td>
            <td>{{ sup.SupplierName }}</td>
            <td>{{ sup.Category }}</td>
            <td>{{ sup.change_status|capfirst }}</td> <!-- new -->
            <td>{{ sup.PointPerson }}</td>
             {# Contact Number #}
            <td class="multi-cell">
              {{ sup.contact_list.0 }}
              {% if sup.contact_list|length > 1 %}
                <div class="dropdown-wrapper">
                  <span class="toggle-dropdown">‚ñº</span>
                  <ul class="dropdown-list">
                    {% for num in sup.contact_list|slice:"1:" %}
                      <li>{{ num }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </td>
            
            {# Email Address #}
            <td class="multi-cell">
              {{ sup.email_list.0 }}
              {% if sup.email_list|length > 1 %}
                <div class="dropdown-wrapper">
                  <span class="toggle-dropdown">‚ñº</span>
                  <ul class="dropdown-list">
                    {% for email in sup.email_list|slice:"1:" %}
                      <li>{{ email }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </td>
            
            {# Social Media #}
            <td class="multi-cell">
              {{ sup.sm_list.0 }}
              {% if sup.sm_list|length > 1 %}
                <div class="dropdown-wrapper">
                  <span class="toggle-dropdown">‚ñº</span>
                  <ul class="dropdown-list">
                    {% for sm in sup.sm_list|slice:"1:" %}
                      <li>{{ sm }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </td>
            
            
            <td>
              <button class="update-button" 
              onclick="openUpdateModalSupplier(
                  '{{ sup.SupplierCode }}',
                  '{{ sup.SupplierCode }}',
                  '{{ sup.SupplierName }}',
                  '{{ sup.Category }}',
                  '{{ sup.SocialMedia }}',
                  '{{ sup.EmailAddress }}',
                  '{{ sup.ContactNumber }}',
                  '{{ sup.PointPerson }}',
                  '{{ sup.change_status }}'
              )">Update</button>
              <button class="delete-button" onclick="openDeleteModalSupplier('{{ sup.SupplierCode }}','{{ sup.SupplierName }}')">Delete</button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9">No Suppliers Found.</td>
          </tr>
          {% endfor %}
          <tr id="noResultsRow" style="display: none;">
            <td colspan="9" style="text-align: center; color: gray;">No matching suppliers found.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ADD SUPPLIER MODAL -->
<div id="addSupplierModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add Supplier</h2>
      <span class="close" onclick="closeModal('addSupplierModal')">&times;</span>
    </div>
    <form method="POST" action="{% url 'supplier_create' %}" id="createSupplierForm" class="form-vertical">
      {% csrf_token %}

      <!-- Supplier Code -->
      <div class="form-group">
        <label for="supplier_code_create">
          Supplier Code<span class="required-asterisk">*</span>:
        </label>
        <input type="text" name="SupplierCode" id="supplier_code_create" required>
      </div>

      <!-- Supplier Name -->
      <div class="form-group">
        <label for="supplier_name_create">
          Supplier Name<span class="required-asterisk">*</span>:
        </label>
        <input type="text" name="SupplierName" id="supplier_name_create" required>
      </div>

      <!-- Category -->
      <div class="form-group">
        <label>Category<span class="required-asterisk">*</span>:</label>
        <div class="radio-group">
          <div class="radio-option">
            <input type="radio" name="Category" id="categoryIngredientCreate" value="Ingredient" required>
            <label for="categoryIngredientCreate">Ingredient</label>
          </div>
          <div class="radio-option">
            <input type="radio" name="Category" id="categoryPackagingCreate" value="Packaging">
            <label for="categoryPackagingCreate">Packaging</label>
          </div>
          <div class="radio-option">
            <input type="radio" name="Category" id="categoryBothCreate" value="Both">
            <label for="categoryBothCreate">Both</label>
          </div>
        </div>
      </div>
            <!-- Point Person -->
      <div class="form-group">
        <label for="point_person_create">Point Person:</label>
        <input type="text" name="PointPerson" id="point_person_create">
      </div>

      <!-- (optional) default status -->
      <input type="hidden" name="change_status" value="active">

      <!-- Social Media -->
      <div class="multi-field" data-field-name="SocialMedia">
        <label>Social Media:</label>
        <div class="fields-wrap">
          <div class="field-row">
            <input type="url" name="SocialMedia[]" id="social_media_create_0" placeholder="https://‚Ä¶" />
          </div>
        </div>
        <button type="button" class="add-btn" data-field-name="SocialMedia">+ Add more</button>
      </div>

      <!-- Email Address -->
      <div class="multi-field" data-field-name="EmailAddress">
        <label>Email Address:</label>
        <div class="fields-wrap">
          <div class="field-row">
            <input type="email" name="EmailAddress[]" id="email_address_create_0" placeholder="name@example.com" />
          </div>
        </div>
        <button type="button" class="add-btn" data-field-name="EmailAddress">+ Add more</button>
      </div>

      <!-- Contact Number -->
      <div class="multi-field" data-field-name="ContactNumber">
        <label>Contact Number:</label>
        <div class="fields-wrap">
          <div class="field-row">
            <input type="tel" name="ContactNumber[]" id="contact_number_create_0" placeholder="+63‚Ä¶" pattern="^[0-9+\\-\\s]+$"/>
          </div>
        </div>
        <button type="button" class="add-btn" data-field-name="ContactNumber">+ Add more</button>
      </div>



      <div class="button-container">
        <button type="button" class="button-outline" onclick="closeModal('addSupplierModal')">Discard</button>
        <button type="submit" class="update-button">Save</button>
      </div>
    </form>
  </div>
</div>



  <!-- SUPPLIER UPDATE MODAL -->
<div id="updateSupplierModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Update Supplier</h2>
      <span class="close" onclick="closeModal('updateSupplierModal')">&times;</span>
    </div>
    <form method="POST" id="updateSupplierForm">
      {% csrf_token %}

      <!-- SupplierCode, Name, Category unchanged‚Ä¶ -->

      <label for="supplier_code_update">Supplier Code:</label>
      <input type="text" name="SupplierCode" id="supplier_code_update" readonly>

      <label for="supplier_name_update">Supplier Name<span style="color:red;">*</span>:</label>
      <input type="text" name="SupplierName" id="supplier_name_update" required>

      <label for="category_update">Category<span style="color:red;">*</span>:</label>
      <select name="Category" id="category_update" required>
        <option value="Ingredient">Ingredient</option>
        <option value="Packaging">Packaging</option>
        <option value="Both">Both</option>
      </select>

      <label for="change_status_update">Status<span class="required-asterisk">*</span>:</label>
        <select name="change_status" id="change_status_update" required>
          <option value="active">Active</option>
          <option value="deleted">Deleted</option>
        </select>

      <label for="point_person_update">Point Person:</label>
      <input type="text"
             name="PointPerson"
             id="point_person_update"
             />
      <!-- Now the 3 multi-fields: -->

      <!-- Social Media -->
      <div class="multi-field" data-field-name="SocialMedia">
        <label>Social Media:</label>
        <div class="fields-wrap">
          <div class="field-row">
            <input type="url" name="SocialMedia[]" id="social_media_update_0" placeholder="https://‚Ä¶" />
          </div>
        </div>
        <button type="button" class="add-btn" data-field-name="SocialMedia">+ Add more</button>
      </div>
      
      <!-- Email Address -->
      <div class="multi-field" data-field-name="EmailAddress">
        <label>Email Address:</label>
        <div class="fields-wrap">
          <div class="field-row">
            <input type="email" name="EmailAddress[]" id="email_address_update_0" placeholder="name@example.com" />
          </div>
          <button type="button" class="add-btn" data-field-name="EmailAddress">+ Add more</button>
      </div>

      <!-- Contact Number -->
      <div class="multi-field" data-field-name="ContactNumber">
        <label>Contact Number:</label>
        <div class="fields-wrap">
          <div class="field-row">
            <input type="tel" name="ContactNumber[]" id="contact_number_update_0" placeholder="+63‚Ä¶" pattern="^[0-9+\-\s]+$"/>
          </div>
    </div>
    <button type="button" class="add-btn" data-field-name="ContactNumber">+ Add more</button>
      </div>


      

      <!-- Password and buttons unchanged‚Ä¶ -->
      <div class="form-group">
        <label for="deleteUsedPassword">
          Password<span style="color:red;">*</span>:
        </label>
        <input type="password" id="deleteUsedPassword" name="password" required>
      </div>
      <div class="button-container">
        <button type="button" class="button-outline" onclick="closeModal('updateSupplierModal')">Cancel</button>
        <button type="submit" class="update-button">Save Changes</button>
      </div>
    </form>
  </div>
</div>


  <!-- DELETE SUPPLIER MODAL -->
  <div id="deleteSupplierModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Delete Supplier</h2>
        <span class="close" onclick="closeModal('deleteSupplierModal')">&times;</span>
      </div>
      <p id="deleteSupplierMessage">Are you sure you want to delete this supplier?</p>
      <form method="POST" id="deleteSupplierForm">
        {% csrf_token %}
        <div class="form-group">
          <label for="deletePassword">
            Password<span class="required-asterisk">*</span>:
          </label>
          <input type="password" id="deletePassword" name="password" required>
        </div>
        <div class="button-container">
          <button type="submit" class="update-button">Delete</button>
          <button type="button" class="button-outline" onclick="closeModal('deleteSupplierModal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript for Suppliers Modals -->
  <script>
    function openModal(id) {
      document.getElementById(id).style.display = "flex";
    }
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }
function openUpdateModalSupplier(pk, supplierCode, supplierName, category, socialMedia, emailAddress, contactNumber, pointPerson, changeStatus) {
  // 1. Set the form action
  const form = document.getElementById('updateSupplierForm');
  form.action = `/suppliers/update/${pk}/`;

  // 2. Update the modal title with the supplier code
  document.getElementById('modalSupplierCode').textContent = supplierCode;

  // 3. Clear or prefill inputs
  document.getElementById('updatePassword').value = '';  // always clear password for security
  document.getElementById('SupplierName').value = supplierName;

  // 4. Check the appropriate category radio
  document.getElementById('categoryIngredient').checked = (category === 'Ingredient');
  document.getElementById('categoryPackaging').checked  = (category === 'Packaging');
  document.getElementById('categoryBoth').checked       = (category === 'Both');

  // 5. Prefill the rest of the fields
  document.getElementById('SocialMedia').value    = socialMedia;
  document.getElementById('EmailAddress').value   = emailAddress;
  document.getElementById('ContactNumber').value  = contactNumber;
  document.getElementById('PointPerson').value    = pointPerson;
  // 6. Finally, open the modal
  openModal('updateSupplierModal');
}

    function openDeleteModalSupplier(pk, name) {
      document.getElementById('deleteSupplierMessage').textContent =
        `Are you sure you want to delete "${name}"?`;
      document.getElementById('deleteSupplierForm').action = `/suppliers/delete/${pk}/`;
      openModal('deleteSupplierModal');
    }
    window.onclick = function(e) {
      const modals = ['addSupplierModal','updateSupplierModal','deleteSupplierModal'];
      modals.forEach(function(id) {
        const modal = document.getElementById(id);
        if (e.target === modal) {
          closeModal(id);
        }
      });
    }
  const supRowsPerPage = 3;
  let supCurrentPage = 1;
  let filteredRows = null;

  function paginateSupplierTable() {
    const allRows = Array.from(document.querySelectorAll('#supplierTableBody tr:not(#noResultsRow)'));

    const rowsToPaginate = filteredRows === null ? allRows : filteredRows;

    const totalPages = Math.ceil(rowsToPaginate.length / supRowsPerPage) || 1;
    supCurrentPage = Math.min(supCurrentPage, totalPages);

    document.getElementById('supTotalPages').textContent = totalPages;
    document.getElementById('supCurrentPage').textContent = supCurrentPage;

    // First hide everything (including noResultsRow)
    allRows.forEach(row => row.style.display = 'none');
    document.getElementById('noResultsRow').style.display = 'none';

    // If there are no rows to show, display the "no results" row
    if (rowsToPaginate.length === 0 && filteredRows !== null) {
      document.getElementById('noResultsRow').style.display = '';
      return;
    }

    // Show paginated slice
    const start = (supCurrentPage - 1) * supRowsPerPage;
    const end = supCurrentPage * supRowsPerPage;
    rowsToPaginate.slice(start, end).forEach(row => row.style.display = '');

    // Enable/disable navigation
    document.getElementById('supPrev').disabled = supCurrentPage === 1;
    document.getElementById('supNext').disabled = supCurrentPage === totalPages;
  }

  function changeSupplierPage(direction) {
    supCurrentPage += direction;
    paginateSupplierTable();
  }

  function filterSupplierTable() {
    const query = document.getElementById('supplierSearchInput').value.toLowerCase().trim();
    const allRows = Array.from(document.querySelectorAll('#supplierTableBody tr:not(#noResultsRow)'));

    if (query === '') {
      filteredRows = null; // Reset filter
    } else {
      filteredRows = allRows.filter(row => {
        const cells = row.querySelectorAll('td');
        const code = (cells[0]?.textContent || '').toLowerCase();
        const name = (cells[1]?.textContent || '').toLowerCase();
        return code.includes(query) || name.includes(query);
      });
    }

    supCurrentPage = 1;
    paginateSupplierTable();
  }

  // Event bindings
  document.addEventListener('DOMContentLoaded', paginateSupplierTable);
  document.getElementById('supplierSearchInput').addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      filterSupplierTable();
    }
  });
  document.getElementById('supplierSearchIcon').addEventListener('click', filterSupplierTable);
  document.getElementById('supplierFilterMenu').addEventListener('click', () => {
    alert('Filter options coming soon...');
  });


  // Run once on page load
document.addEventListener('DOMContentLoaded', () => {
  // Delegate all ‚ÄúAdd more‚Äù clicks
  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const field = btn.dataset.fieldName;       // e.g. "EmailAddress"
      const container = btn.closest('.multi-field').querySelector('.fields-wrap');
      // Clone the first row:
      const prototype = container.querySelector('.field-row');
      const clone = prototype.cloneNode(true);
      const input = clone.querySelector('input');
      input.value = '';                          // clear old value
      // Re-id it so each is unique (optional):
      const idx = container.querySelectorAll('.field-row').length;
      input.id = `${input.name.replace('[]','')}_${idx}`;
      container.appendChild(clone);
    });
  });
});

// Override to inject existing data & open the modal
function openUpdateModalSupplier(pk, supplierCode, supplierName, category, socialMedia, emailAddress, contactNumber, pointPerson,changeStatus) {
  const form = document.getElementById('updateSupplierForm');
  form.action = `/suppliers/update/${pk}/`;
  
  document.getElementById('supplier_code_update').value = supplierCode;
  document.getElementById('supplier_name_update').value = supplierName;
  document.getElementById('category_update').value = category;
  document.getElementById('change_status_update').value = changeStatus;  // new
  document.getElementById('point_person_update').value    = pointPerson;  // <‚Äî add this line!


  // Helper: split on comma or semicolon, trim, drop empties
  const splitList = str => str
    ? str.split(/[;,]/).map(s=>s.trim()).filter(Boolean)
    : [];

  // For each multi-field type, clear old rows and re-create
  const types = ['SocialMedia','EmailAddress','ContactNumber'];
  types.forEach(type => {
    const raw = { SocialMedia: socialMedia,
                  EmailAddress: emailAddress,
                  ContactNumber: contactNumber,
                }[type] || '';
    const list = splitList(raw);

    const wrapper = document.querySelector(`.multi-field[data-field-name="${type}"] .fields-wrap`);
    // remove all but the first row:
    wrapper.querySelectorAll('.field-row')
      .forEach((row, i) => { if (i>0) row.remove(); });

    // fill 
    wrapper.querySelector('input').value = list[0]||'';
    // clone extras
    list.slice(1).forEach(val => {
      const clone = wrapper.querySelector('.field-row').cloneNode(true);
      clone.querySelector('input').value = val;
      wrapper.appendChild(clone);
    });
  });

  openModal('updateSupplierModal');
}
// Pin‚Äêopen on click
document.querySelectorAll('.toggle-dropdown').forEach(icon => {
  icon.addEventListener('click', e => {
    const wrapper = icon.closest('.dropdown-wrapper');
    wrapper.classList.toggle('open');
    e.stopPropagation();
  });
});
// Close when clicking outside
document.addEventListener('click', () => {
  document.querySelectorAll('.dropdown-wrapper.open')
          .forEach(w => w.classList.remove('open'));
});
</script>

</body>
</html>
